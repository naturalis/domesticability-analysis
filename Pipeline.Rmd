---
title: "Pipeline_UngulateTraits"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T)
```

# 1 Import data

First the needed packages, data and phylogenetic tree are loaded into R. The root of the
GitHub repository must be declared for the data to be found. The trait data and OMI data 
need to be merged.

### Load packages
```{r Load packages, message=FALSE}
library(ape)
library(dplyr)
library(ggtree)
library(ggplot2)
library(Rphylopars)
library(tidyverse)
library(usdm)
```

### Declare project root and paths
```{r declare root and paths}
root <- "/home/zoe/Documents/GitHub/trait-organismal-ungulates-R"
treeFile <- paste(c(root, "/data/ungulates.tree"), collapse = "")
ungulatesFile <- paste(c(root, "/data/CSV/ungulatesTraits.csv"), collapse = "")
omiFile <- ("https://raw.githubusercontent.com/naturalis/trait-geo-diverse-ungulates/master/results/OMI/niche_traits.csv")
```

### Import tree and domestication data
```{r import data}
ungulatesData <- read.csv(ungulatesFile, header = TRUE, sep= ",")
omi <- read.csv(omiFile)
omi$X <- gsub(" ", "_", omi$X)
tree <- read.tree(treeFile)
```

### Merge datasets
```{r merge data}
ungulatesData <- ungulatesData[2:59]
omi <- omi %>% rename(BinomialName = X)
dataset <- merge(ungulatesData, omi, by="BinomialName", all=T)
dataset <- dataset[-c(258:265),]
rm(ungulatesData)

#write to csv for use outside of R-Studio
write.csv(dataset, "/home/zoe/Documents/GitHub/trait-organismal-ungulates-R/mergedData.csv", row.names=FALSE)
```

# 2 Preprocessing

There are names in the phylogenetic tree that aren't in the dataset, these tips can be
dropped. Rename trait names that contain dots, remove traits that consist of more than 
200 missing values and remove traits that don't have any information gain.

```{r check if names match between dataset and tree}
#drop tips that aren't in dataset
tips_drop <- setdiff(tree$tip.label, dataset$BinomialName)
phyloTree <- drop.tip(tree, tips_drop)
rm(tree)


#rename columns with dots in the name
dataset <- dataset %>% rename(Horns_Antlers = Horns.Antlers,
                              X21.1_PopulationDensity_n_km2 = X21.1_PopulationDensity_n.km2)


#remove traits that (almost) only consist of missing values (>200 NA)
dataset <- subset(dataset, select = -c(X8.1_AdultForearmLen_mm, X18.1_BasalMetRate_mLO2hr, X5.2_BasalMetRateMass_g, X7.1_DispersalAge_d, X16.1_LittersPerYear, X13.2_NeonateHeadBodyLen_mm, X10.1_PopulationGrpSize, X13.3_WeaningHeadBodyLen_mm, X5.4_WeaningBodyMass_g, X2.1_AgeatEyeOpening_d))


#remove traits without any information gain (only consist of one value)
dataset <- subset(dataset, select = -c(Motility, ParentalCare, X12.2_Terrestriality))


#remove traits that are almost identical to other traits
dataset <- subset(dataset, select = -c(PullStrength, NumOffspring, BreedingInterval, 
                                       Diet, AVGWeight, MaturityReachFemale,
                                       MaturityReachMale, X22.2_HomeRange_Indiv_km2,
                                       X5.3_NeonateBodyMass_g))

domestic <- subset(dataset, dataset$Domestication == "1")
wild <- subset(dataset, dataset$Domestication == "2")



```


# 3 Distance Matrix
### Not sure what to do with this yet
Make a distance matrix, which shows the phylogenetic distances between all the species in 
the tree.

```{r distance matrix calculations}
#distances <- cophenetic.phylo(phyloTree)
```


# 4 VIF-analysis

There probably will be some colinearity between the different traits in the dataset. 
Colinearity could lead to bias in the model, so a correction will have to be done. This can be done using the Variance Inflation Factor (vif).

### WIP
```{r general code VIF analysis, results='markup'}
predictors <- dataset[,c(7:77)]
vif(predictors)
```



# Information about data per predictor variable
summary(dataset)
str(dataset)
dataset$BinomialName
