---
title: "VIF"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T)
```

# VIF-analysis

There are alot of traits in the dataset, which can lead to colinearity. To eliminate most of
the colinearity, a VIF analysis will be done. Loading the data is done with the 'Import data' 
and 'Preprocessing' part of the Pipeline.Rmd script.

```{r load packages, message=FALSE}
library(usdm)
```


## General code

This is the general code for the VIF analysis, which will change due to new values being left out during
the analysis. The VIF value and biological reasoning will help with choosing which traits should be left
out.

```{r general code}
predictors <- dataset[,c(7:77)]
vif(predictors)
```

## Correlation Matrix
A correlation matrix can help with finding out which traits have a very high colinearity.

```{r correlation matrix}
library(caret)
columns <- dataset[,c(7:77)]
matrix <- cor(columns,use = "pairwise.complete.obs")
findCorrelation(matrix, cutoff = 0.9, verbose = TRUE, exact=FALSE)
```

Removed following columns with the help of the correlation matrix:
2,8,34,37,38,39,40,41,44,49,53,56,57,58,59,61,62,63,64,65,69

```{r remove flagged columns}
testdata <- columns[,c(1,3:7,9:33,35,36,42,43,45:48,50:52,54,55,60,66:68,70,71)]
testmatrix <- cor(testdata, use = "pairwise.complete.obs")
findCorrelation(testmatrix, cutoff = 0.9, verbose = TRUE, exact = TRUE)

# Still infinite numbers
vif(testdata[,c(1:50)])

```

## Based on VIF values

Traits were removed using only the VIF values: the highest VIF values is removed until the remaining
traits have a VIF of 10 or lower.

#### Trait data only

Some traits have a very high colinearity with other traits, because they fall into the same category 
(for example LitterSize and TeatNumber, which both have to do with offspring). When there is a very high colinearity, the VIF analysis shows only infinite instead of numbers as a VIF value. Because of this, the removal of very high colinearity needs to be done in smaller steps.

``` {r trait only - 7:20}
# Round 1 with the following traits:
# X1.1_ActivityCycle, X5.1_AdultBodyMass_g, X13.1_AdultHeadBodyLen_mm, X3.1_AgeatFirstBirth_d,
# X6.1_DietBreadth, X9.1_GestationLen_d, X12.1_HabitatBreadth, X22.1_HomeRange_km2, 
# X14.1_InterbirthInterval_d, X15.1_LitterSize, X17.1_MaxLongevity_m, X21.1_PopulationDensity_n_km2,
# X23.1_SexualMaturityAge_d, X10.2_SocialGrpSize
vif(dataset[,c(7:20)])

# Removed: X5.1_AdultBodyMass_g(8), X3.1_AgeatFirstBirth_d(10), X9.1_GestationLen_d(12),
# X17.1_MaxLongevity_m(17)
vif(dataset[,c(7, 9, 11, 13:16, 18:20)])
```


```{r trait only - 21:36}
# Round 2 with the following traits:
# X24.1_TeatNumber, X6.2_TrophicLevel, X25.1_WeaningAge_d, AVGFoodConsumption, Sociality, 
# SocialHierarchy, NumMales, MatingSystem, YearRoundBreeding, DevelopmentStrategy, Horns_Antlers,
# Lifespan, NaturalPredators, CarryWeight, AVGMovingSpeed, AVGTravelDistance
vif(dataset[,c(21:36)])

# Removed: X6.2_TrophicLevel(22), NaturalPredators(33), CarryWeight(34), AVGTravelDistance(36)
vif(dataset[,c(21, 23:32, 35)])
```


```{r trait only - 7:36}
# Round 3 with following traits:
# X1.1_ActivityCycle, X13.1_AdultHeadBodyLen_mm, X6.1_DietBreadth, X12.1_HabitatBreadth, 
# X22.1_HomeRange_km2, X14.1_InterbirthInterval_d, X15.1_LitterSize, X17.1_MaxLongevity_m, 
# X21.1_PopulationDensity_n_km2, X23.1_SexualMaturityAge_d, X10.2_SocialGrpSize, X24.1_TeatNumber, 
# X25.1_WeaningAge_d, AVGFoodConsumption, Sociality, SocialHierarchy, NumMales, MatingSystem, 
# YearRoundBreeding, DevelopmentStrategy, Horns_Antlers, Lifespan, AVGMovingSpeed
vif(dataset[,c(7, 9, 11, 13:16, 18:21, 23:32, 35)])

# Removed: X13.1_AdultHeadBodyLen_mm(9), X14.1_InterbirthInterval_d(15), X23.1_SexualMaturityAge_d(19), 
# X24.1_TeatNumber(21), X25.1_WeaningAge_d(23), AVGFoodConsumption(24), Sociality(25), MatingSystem(28),
# YearRoundBreeding(29), AVGMovingSpeed(35)

# Added earlier removed traits, which made the VIF values better: NaturalPredators(33), CarryWeight(34)
vif(dataset[,c(7, 11, 13, 14, 16, 18, 20, 26, 27, 30:34)])

# We want BodyMass to be in the traits for the modelling. When we swap out CarryWeight with BodyMass, 
# (those two traits have a high colinearity, because CarryWeight was calculated using the bodymass) the 
# VIF values work perfectly.
vif(dataset[,c(7, 8, 11, 13, 14, 16, 18, 20, 26, 27, 30:33)])
```


#### OMI data only

The OMI data is highly correlated with itself. To keep it organized, the VIF analysis is done in several
smaller steps.

```{r omi only - 36:77}
# Round 1 with:
# Aspect, BulkDensity, ClayPercentage, annualPET, aridityIndexThornthwaite, climaticMoistureIndex,
# continentality, embergerQ, growingDegDays0, growingDegDays5, maxTempColdest, minTempWarmest, 
# monthCountByTemp10, PETColdestQuarter, PETDriestQuarter, PETseasonality, PETWarmestQuarter, 
# PETWettestQuarter, thermicityIndex, OrganicCarbon, PhCaCL, Slope, bio1, bio2, bio3, bio4, bio5, bio6,
# bio7, bio8, bio9, bio10, bio11, bio12, bio13, bio14, bio15, bio16, bio17, bio18, bio19
vif(dataset[,c(37:77)])

# Removed: annualPET(40), aridityIndexThornthwaite(41), climaticMoistureIndex(42), continentality(43), 
# embergerQ(44), growingDegDays0(45), growingDegDays5(46), maxTempColdest(47), minTempWarmest(48), 
# monthCountByTemp10(49), PETColdestQuarter(50), PETWarmestQuarter(53), thermicityIndex(55), bio1(59), 
# bio3(61), bio4(62), bio5(63), bio6(64), bio8(66), bio9(67), bio10(68), bio11(69), bio12(70), bio13(71),
# bio16(74), bio17(75), 
vif(dataset[,c(37:39, 51, 52, 54, 56:58, 60, 65, 72, 73, 76, 77)])
```




#### Both the traits and OMI datasets
#### WIP
Very difficult, bodymass correlates with alot of traits and OMI data

```{r traits + OMI}
vif(dataset[,c(7, 8, 11, 13, 14, 16, 18, 20, 26, 27, 30:33)])
vif(dataset[,c(37:39, 51, 52, 54, 56:58, 60, 65, 72, 73, 76, 77)])

vif(dataset[,c(7, 8, 11, 13, 14, 16, 18, 20, 26, 27, 30:33, 37:39, 51, 52)])
```

## Based on VIF values and biology

Traits were removed using VIF values and biological knowledge: the highest VIF values are removed, using 
biological reasoning, until the remaining traits have a VIF of 10 or lower.

#### Trait data only
WIP


## OMI data only
WIP


## Trait and OMI dataset

When the trait and OMI data is merged and analysed, a high colinearity is seen. To keep it organized,
the VIF analysis is done in several smaller steps.

