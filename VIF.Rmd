---
title: "VIF"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T)
```

# VIF-analysis

There are alot of traits in the dataset, which can lead to collinearity. To eliminate most of
the collinearity, a VIF analysis will be done. Loading the data is done with the 'Import data' 
and 'Preprocessing' part of the Pipeline.Rmd script.

```{r load packages, message=FALSE}
library(usdm)
library(caret)
library(corrplot)
```


### General code VIF

This is the general code for the VIF analysis, which will change due to new values being left out during
the analysis. The VIF value and biological reasoning will help with choosing which traits should be left
out.

```{r general code VIF, message=FALSE}
columns <- dataset[,c(7:77)]
vif(columns)
```


### Correlation Matrix

A VIF analysis with all the predictors results in only infinite values. A correlation matrix can help
with finding which traits have a very high collinearity, so they can be removed and a VIF analysis 
can be properly done.

```{r general code matrix}
# Make matrix
matrix <- cor(columns, use = "pairwise.complete.obs")

# Visualize matrix
corrplot(matrix, type="lower", order = "hclust", tl.pos = "l", tl.col = "black", tl.cex = 0.7)
```

#### Find highest correlation

The corrplot package is used to visualize the collinearity between the traits, using the 
correlation matrix. With the findCorrelation function, the columns with the highest collinearity are 
found. By visualizing the matrix, the outcome of the findCorrelation function can be easily checked. 
At the beginning of every round the VIF function is run, to check if the results are still infinite.

```{r visualize matrix}
# Round1
plotPredictors <- columns[,c(1:71)]

## Check VIF > still infinite values
vif(plotPredictors)

## Construct matrix and visualize
matrix <- cor(plotPredictors, use = "pairwise.complete.obs")
corrplot(matrix, type="lower", order = "hclust", tl.pos = "l", tl.col = "black", tl.cex = 0.7)

## Find all traits with a correlation of .9 or higher, and -.9 and lower
## Result: remove 39 40 41 44 49 53 56 57 58 59 61 62 63 69  2  8 34 37 38 64 65
findCorrelation(matrix, cutoff = .9, verbose = FALSE, exact=FALSE)


# Round2
plotPredictors <- plotPredictors[,c(1,3:7,9:33,35,36,38,42,43,45:48,50:52,54,55,60,66:68,70,71)]

## Check VIF > still infinite values
vif(plotPredictors)

## Construct matrix and visualize
matrix <- cor(plotPredictors, use = "pairwise.complete.obs")
corrplot(matrix, type="lower", order = "hclust", tl.pos = "l", tl.col = "black", tl.cex = 0.7)

## Find all traits with a correlation of .8 or higher, and -.8 and lower
## Result: remove 7 11 13 33 36 45 46 47  3 34 32 49
findCorrelation(matrix, cutoff = .8, verbose=FALSE, exact = FALSE)


# Round3
plotPredictors <- plotPredictors[,c(1,2,4:6,8:10,12,14:31,35,37:44,48,50,51)]

## Check VIF > still infinite values
vif(plotPredictors)

## Construct matrix and visualize
matrix <- cor(plotPredictors, use = "pairwise.complete.obs")
corrplot(matrix, type="lower", order = "hclust", tl.pos = "l", tl.col = "black", tl.cex = 0.7)

## Find all traits with a correlation of .7 or higher, and -.7 and lower
## Result: remove 7 11 31 2 26
findCorrelation(matrix, cutoff = .7, verbose=FALSE, exact = FALSE)


# Round4
plotPredictors <- plotPredictors[,c(1,3:6,8:10,12:25,27:30,32:39)]

## Check VIF > still infinite values
vif(plotPredictors)

## Construct matrix and visualize
matrix <- cor(plotPredictors, use = "pairwise.complete.obs")
corrplot(matrix, type="lower", order = "hclust", tl.pos = "l", tl.col = "black", tl.cex = 0.7)

## Find all traits with a correlation of .6 or higher, and -.6 and lower
## Result: remove 19 25 34 24 31
findCorrelation(matrix, cutoff = .6, verbose=FALSE, exact = FALSE)


# Round5
plotPredictors <- plotPredictors[,c(1:18,20:23,26:30,32,33)]

## Check VIF > still infinite values
vif(plotPredictors)

## Construct matrix and visualize
matrix <- cor(plotPredictors, use = "pairwise.complete.obs")
corrplot(matrix, type="lower", order = "hclust", tl.pos = "l", tl.col = "black", tl.cex = 0.7)

## Find all traits with a correlation of .5 or higher, and -.5 and lower
## Result: remove 8 17 23 29 10 24
findCorrelation(matrix, cutoff = .5, verbose=FALSE, exact = FALSE)


# Round6
plotPredictors <- plotPredictors[,c(1:7,9,11:16,18:22,25:28)]

## Check VIF > still infinite values
vif(plotPredictors)

## Construct matrix and visualize
matrix <- cor(plotPredictors, use = "pairwise.complete.obs")
corrplot(matrix, type="lower", order = "hclust", tl.pos = "l", tl.col = "black", tl.cex = 0.7)

## Find all traits with a correlation of .4 or higher, and -.4 and lower
## Result: remove 9 10 23 21
findCorrelation(matrix, cutoff = .4, verbose=FALSE, exact = FALSE)


# Round7
plotPredictors <- plotPredictors[,c(1:8,11:20,22)]

## Check VIF > no infinite values
vif(plotPredictors)

## Construct matrix and visualize
matrix <- cor(plotPredictors, use = "pairwise.complete.obs")
corrplot(matrix, type="lower", order = "hclust", tl.pos = "l", tl.col = "black", tl.cex = 0.7)
```

#### Declare predictor set

The set of predictors is declared for the VIF analysis, and a last check for collinearity using the
visualized matrix is done. During the first round the AdultBodyMass is removed due to a high collinearity
with other traits. The bodymass is an important trait, so it will be reinserted in this step.

``` {r declare predictor set}
# Insert X5.1_AdultBodyMass_g (column 2) and check for high collinearity
setPredictors <- columns[,c(1,2,5:7,10,12,14,18,22:25,27,29:31,33,50,52)]
matrix <- cor(setPredictors, use = "pairwise.complete.obs")
corrplot(matrix, type="lower", order = "hclust", tl.pos = "l", tl.col = "black", tl.cex = 0.7)

# X5.1_AdultBodyMass_g and X9.1_GestationLen_d have a high collinearity. X5.1_AdultBodyMass_g seems more 
# important for this research, so X9.1_GestationLen_d (column 6) is removed.
setPredictors <- columns[,c(1,2,5,7,10,12,14,18,22:25,27,29:31,33,50,52)]
matrix <- cor(setPredictors, use = "pairwise.complete.obs")
corrplot(matrix, type="lower", order = "hclust", tl.pos = "l", tl.col = "black", tl.cex = 0.7)
```


### VIF Analysis

During the VIF analysis traits are removed using the VIF values: the highest values are removed until the
remaining traits have a VIF of 10 or lower.

```{r VIF}
# Round1 - Results: remove AVGFoodConsumption
vif(setPredictors)

# Round2 - Results: remove YearRoundBreeding
setPredictors <- setPredictors[,c(1:7,9:19)]
vif(setPredictors)

# Round3 - Results: all of the traits are under 10 (except X5.1_AdultBodyMass_g)
setPredictors <- setPredictors[,c(1:8, 10:18)]
vif(setPredictors)
```


### Final predictor set

The final set of predictors is declared.

```{r declare predictors}
# Final set of predictors, containing:
# X1.1_ActivityCycle, X5.1_AdultBodyMass_g, X6.1_DietBreadth, X12.1_HabitatBreadth, X15.1_LitterSize, 
# X21.1_PopulationDensity_n_km2, X10.2_SocialGrpSize, MatingSystem, DevelopmentStrategy, Horns_Antlers, 
# NaturalPredators, AVGMovingSpeed, AVGTravelDistance, Aspect, ClayPercentage, OrganicCarbon, Slope
predictors <- columns[,c(1,2,5,7,10,12,14,22,24,25,27,29:31,33,50,52)]
vif(predictors)
```


