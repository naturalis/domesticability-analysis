---
title: "ModelSelection"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T)
```

# Added - Will later remove

Added this part to make the dataset and tree. Same as in Pipeline.Rmd.
Phyloglmstep starts at the header Model Selection

```{r packages}
library(ape)
library(dplyr)
library(plyr)
library(ggtree)
library(ggplot2)
library(Rphylopars)
library(tidyverse)
library(usdm)
library(corrplot)
```

#### data and tree
```{r declare root and paths}
root <- "/home/zoe/Documents/GitHub/trait-organismal-ungulates-R"
treeFile <- paste(c(root, "/data/ungulates.tree"), collapse = "")
ungulatesFile <- paste(c(root, "/data/CSV/ungulatesTraits.csv"), collapse = "")
omiFile <- ("https://raw.githubusercontent.com/naturalis/trait-geo-diverse-ungulates/master/results/OMI/niche_traits.csv")

ungulatesData <- read.csv(ungulatesFile, header = TRUE, sep= ",")
omi <- read.csv(omiFile)
tree <- read.tree(treeFile)

ungulatesData <- ungulatesData[2:60]
omi <- omi %>% rename(CanonicalName = X)
dataset <- merge(ungulatesData, omi, by="CanonicalName")
dataset$CanonicalName <- gsub(" ", "_", dataset$CanonicalName)

# Remove all unnecessary variables 
rm(treeFile, ungulatesFile, omiFile, ungulatesData, omi)

# Which species aren't in the tree
dropRows <- setdiff(dataset$CanonicalName, tree$tip.label)

# Drop rows that aren't in the tree, and aren't domesticated
row.names(dataset) <- dataset$CanonicalName
dataset <- dataset[!(row.names(dataset) %in% dropRows), ]

# Drop tips that aren't in dataset
dropTips <- setdiff(tree$tip.label, dataset$CanonicalName)
tree <- drop.tip(tree, dropTips)

rm(dropRows, dropTips)

#rename columns with dots in the name
dataset <- dataset %>% rename(Horns_Antlers = Horns.Antlers,
                              X21.1_PopulationDensity_n_km2 = X21.1_PopulationDensity_n.km2)


#remove traits that (almost) only consist of missing values (>100 NA)
dataset <- subset(dataset, select = -c(X5.4_WeaningBodyMass_g, X13.3_WeaningHeadBodyLen_mm, X13.2_NeonateHeadBodyLen_mm, X18.1_BasalMetRate_mLO2hr, X5.2_BasalMetRateMass_g, X2.1_AgeatEyeOpening_d, X8.1_AdultForearmLen_mm, X10.1_PopulationGrpSize))


#remove traits without any information gain (only consist of one value)
dataset <- subset(dataset, select = -c(Motility, ParentalCare, X12.2_Terrestriality))


#remove traits that are almost identical to other traits
dataset <- subset(dataset, select = -c(PullStrength, NumOffspring, BreedingInterval, 
                                       Diet, AVGWeight, MaturityReachFemale,
                                       MaturityReachMale, X22.2_HomeRange_Indiv_km2,
                                       X5.3_NeonateBodyMass_g,X16.1_LittersPerYear,X7.1_DispersalAge_d))
```



# Model Selection
The Generalized Linear Model (GLM) must be made. The Domestication column is used as the dependent 
variable, and the other columns are the predictor variables. For the model selection the phylolm package 
and phyloglmstep function are used.


### Load packages
```{r packages}
library(phylolm)
source("https://raw.githubusercontent.com/naturalis/angiosperm-traits/master/phyloglmstep.R")
```


### Data

A dataset without any missing values is made. It contains the Domestication trait, and also the 
CanonicalNames to match the data with the tree. The tree tips that aren't in the final data, are dropped.

```{r data}
# The predictor variables from the VIF analysis + Domestication and CanonicalNames
modelData <- cbind(dataset$CanonicalName, dataset$Domestication,predictors)

# Rename colnames for Domestication and CanonicalName
names(modelData)[names(modelData)=="dataset$Domestication"] <- "Domestication"
names(modelData)[names(modelData)=="dataset$CanonicalName"] <- "CanonicalName"

# Domesticated species
domData <- modelData[modelData$Domestication == 1,]

# Only the rows without any missing values are collected
modelData <- modelData[complete.cases(modelData),]

# Dropping species from the tree, to make the amount of species the same in the data and tree
#setdiff(data$CanonicalName, tree$tip.label)
dropTips <- setdiff(tree$tip.label, modelData$CanonicalName)
modelTree <- drop.tip(tree, dropTips)



rm(columns, dropTips)
```


### Binary dependent variable

The dependent variable should be in a binary state. This means that the Domestication trait needs to be
converted to 0-1 instead of the 1-2 it's now. The 'wild' state (2) will be converted to the zero state (0). This way 'wild' appears as 0 and 'domesticated' appears as 1.

```{r zero state}
modelData$Domestication[modelData$Domestication==2] <- 0 
```

### Formulas

The input formulas are defined, which are going to be used as input for the phyloglmstep function.

```{r declare formulas}
# Starting formula
start_formula <- Domestication ~ 1

# Lowest VIF values - with all traits
formula1 <- Domestication ~ X1.1_ActivityCycle + X5.1_AdultBodyMass_g + X12.1_HabitatBreadth + X21.1_PopulationDensity_n_km2 + X10.2_SocialGrpSize + MatingSystem + YearRoundBreeding + Horns_Antlers + AVGMovingSpeed + AVGTravelDistance + Aspect + ClayPercentage + OrganicCarbon

# Without X12.1_HabitatBreadth
formula2 <- Domestication ~ X1.1_ActivityCycle + X5.1_AdultBodyMass_g + X21.1_PopulationDensity_n_km2 + X10.2_SocialGrpSize + MatingSystem + YearRoundBreeding + Horns_Antlers + AVGMovingSpeed + AVGTravelDistance + Aspect + ClayPercentage + OrganicCarbon

# Without X1.1_ActivityCycle
formula3 <- Domestication ~ X5.1_AdultBodyMass_g + X12.1_HabitatBreadth + X21.1_PopulationDensity_n_km2 + X10.2_SocialGrpSize + MatingSystem + YearRoundBreeding + Horns_Antlers + AVGMovingSpeed + AVGTravelDistance + Aspect + ClayPercentage + OrganicCarbon

# Without X5.1_AdultBodyMass_g
formula4 <- Domestication ~ X1.1_ActivityCycle + X12.1_HabitatBreadth + X21.1_PopulationDensity_n_km2 + X10.2_SocialGrpSize + MatingSystem + YearRoundBreeding + Horns_Antlers + AVGMovingSpeed + AVGTravelDistance + Aspect + ClayPercentage + OrganicCarbon

# Without X21.1_PopulationDensity_n_km2
formula5 <- Domestication ~ X1.1_ActivityCycle + X5.1_AdultBodyMass_g + X12.1_HabitatBreadth + X10.2_SocialGrpSize + MatingSystem + YearRoundBreeding + Horns_Antlers + AVGMovingSpeed + AVGTravelDistance + Aspect + ClayPercentage + OrganicCarbon

# Without X10.2_SocialGrpSize
formula6 <- Domestication ~ X1.1_ActivityCycle + X5.1_AdultBodyMass_g + X12.1_HabitatBreadth + X21.1_PopulationDensity_n_km2 + MatingSystem + YearRoundBreeding + Horns_Antlers + AVGMovingSpeed + AVGTravelDistance + Aspect + ClayPercentage + OrganicCarbon

# Without MatingSystem
formula7 <- Domestication ~ X1.1_ActivityCycle + X5.1_AdultBodyMass_g + X12.1_HabitatBreadth + X21.1_PopulationDensity_n_km2 + X10.2_SocialGrpSize + MatingSystem + YearRoundBreeding + Horns_Antlers + AVGMovingSpeed + AVGTravelDistance + Aspect + ClayPercentage + OrganicCarbon

# Without YearRoundBreeding
formula8 <- Domestication ~ X1.1_ActivityCycle + X5.1_AdultBodyMass_g + X12.1_HabitatBreadth + X21.1_PopulationDensity_n_km2 + X10.2_SocialGrpSize + MatingSystem + YearRoundBreeding + Horns_Antlers + AVGMovingSpeed + AVGTravelDistance + Aspect + ClayPercentage + OrganicCarbon

# Without Horns_Antlers
formula9 <- Domestication ~ X1.1_ActivityCycle + X5.1_AdultBodyMass_g + X12.1_HabitatBreadth + X21.1_PopulationDensity_n_km2 + X10.2_SocialGrpSize + MatingSystem + YearRoundBreeding + Horns_Antlers + AVGMovingSpeed + AVGTravelDistance + Aspect + ClayPercentage + OrganicCarbon

# Without AVGMovingSpeed
formula10 <- Domestication ~ X1.1_ActivityCycle + X5.1_AdultBodyMass_g + X12.1_HabitatBreadth + X21.1_PopulationDensity_n_km2 + X10.2_SocialGrpSize + MatingSystem + YearRoundBreeding + Horns_Antlers + AVGTravelDistance + Aspect + ClayPercentage + OrganicCarbon

# Without AVGTravelDistance
formula11 <- Domestication ~ X1.1_ActivityCycle + X5.1_AdultBodyMass_g + X12.1_HabitatBreadth + X21.1_PopulationDensity_n_km2 + X10.2_SocialGrpSize + MatingSystem + YearRoundBreeding + Horns_Antlers + AVGMovingSpeed + Aspect + ClayPercentage + OrganicCarbon

# Without Aspect
formula12 <- Domestication ~ X1.1_ActivityCycle + X5.1_AdultBodyMass_g + X12.1_HabitatBreadth + X21.1_PopulationDensity_n_km2 + X10.2_SocialGrpSize + MatingSystem + YearRoundBreeding + Horns_Antlers + AVGMovingSpeed + AVGTravelDistance + ClayPercentage + OrganicCarbon

# Without ClayPercentage
formula13 <- Domestication ~ X1.1_ActivityCycle + X5.1_AdultBodyMass_g + X12.1_HabitatBreadth + X21.1_PopulationDensity_n_km2 + X10.2_SocialGrpSize + MatingSystem + YearRoundBreeding + Horns_Antlers + AVGMovingSpeed + AVGTravelDistance + Aspect + OrganicCarbon

# Without OrganicCarbon
formula14 <- Domestication ~ X1.1_ActivityCycle + X5.1_AdultBodyMass_g + X12.1_HabitatBreadth + X21.1_PopulationDensity_n_km2 + X10.2_SocialGrpSize + MatingSystem + YearRoundBreeding + Horns_Antlers + AVGMovingSpeed + AVGTravelDistance + Aspect + ClayPercentage
```

```{r testformula}
# formula for testing phyloglmstep
testFormula <- Domestication ~ X1.1_ActivityCycle + X5.1_AdultBodyMass_g + X12.1_HabitatBreadth + X21.1_PopulationDensity_n_km2 + X10.2_SocialGrpSize + MatingSystem + YearRoundBreeding + Horns_Antlers + AVGMovingSpeed + AVGTravelDistance + Aspect + ClayPercentage + OrganicCarbon
```

### Model selection

With the use of the phyloglmstep() function, written by Rutger Vos.

```{r model selection}
phyloglmstep(testFormula, starting.formula = NULL, data=modelData, phy=modelTree, 
             method="logistic_MPLE", direction = "forward", trace = 2, 
             btol = 30, log.alpha.bound = 4, start.beta=NULL, 
             start.alpha=NULL, boot = 0, full.matrix = TRUE, k=2)
```


